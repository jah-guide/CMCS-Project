<!-- File: Views/HR/LecturerManagement.cshtml -->
@model List<ContractMonthlyClaimSystem.Models.ApplicationUser>
@{
    ViewData["Title"] = "Lecturer Management";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-users-cog"></i> Lecturer Management
        </h2>
        <a href="@Url.Action("Dashboard")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Total Lecturers</h6>
                    <h3>@Model.Count</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Average Rate</h6>
                    <h3>R @(Model.Any() ? Model.Average(l => l.HourlyRate).ToString("F2") : "0.00")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title">Highest Rate</h6>
                    <h3>R @(Model.Any() ? Model.Max(l => l.HourlyRate).ToString("F2") : "0.00")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title">Lowest Rate</h6>
                    <h3>R @(Model.Any() ? Model.Min(l => l.HourlyRate).ToString("F2") : "0.00")</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lecturers Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i> All Lecturers
                <span class="badge bg-secondary">@Model.Count</span>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="lecturersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Hourly Rate</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var lecturer in Model)
                            {
                                <tr>
                                    <td>
                                        <strong>@lecturer.FullName</strong>
                                    </td>
                                    <td>@lecturer.Email</td>
                                    <td>
                                        <span class="badge bg-primary">R @lecturer.HourlyRate.ToString("F2")</span>
                                    </td>
                                    <td>@(lecturer.PhoneNumber ?? "Not set")</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-rate-btn"
                                                data-userid="@lecturer.Id"
                                                data-currentrate="@lecturer.HourlyRate"
                                                data-lecturername="@lecturer.FullName">
                                            <i class="fas fa-edit"></i> Edit Rate
                                        </button>
                                        <a href="mailto:@lecturer.Email" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-envelope"></i> Email
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No lecturers found in the system.
                </div>
            }
        </div>
    </div>

    <!-- Bulk Operations -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-cogs"></i> Bulk Operations
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Increase All Rates by Percentage</h6>
                            <form id="bulkIncreaseForm" method="post" class="row g-3">
                                <div class="col-auto">
                                    <input type="number" class="form-control" id="increasePercentage"
                                           placeholder="Percentage" min="1" max="50" step="0.5">
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-warning" onclick="calculateBulkIncrease()">
                                        <i class="fas fa-calculator"></i> Calculate
                                    </button>
                                </div>
                            </form>
                            <div id="bulkIncreasePreview" class="mt-2" style="display: none;">
                                <small class="text-muted" id="increasePreviewText"></small>
                                <br>
                                <button type="button" class="btn btn-sm btn-success mt-1" onclick="applyBulkIncrease()">
                                    <i class="fas fa-check"></i> Apply Increase
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Export Lecturer Data</h6>
                            <p class="text-muted">Export all lecturer information to CSV</p>
                            <button type="button" class="btn btn-outline-primary" onclick="exportLecturerData()">
                                <i class="fas fa-download"></i> Export to CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rate Modal -->
<div class="modal fade" id="editRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Hourly Rate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateRateForm" method="post" action="@Url.Action("UpdateLecturerRate")">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editUserId" name="userId" />
                    <div class="mb-3">
                        <label for="lecturerName" class="form-label">Lecturer</label>
                        <input type="text" class="form-control" id="lecturerName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newHourlyRate" class="form-label">New Hourly Rate (R)</label>
                        <input type="number" class="form-control" id="newHourlyRate" name="hourlyRate"
                               step="0.01" min="0" max="1000" required>
                        <div class="form-text">Enter the new hourly rate in Rands</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="updateRateForm" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Rate
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize DataTable for better table functionality
            $('#lecturersTable').DataTable({
                pageLength: 25,
                order: [[0, 'asc']]
            });

            // Edit rate button click
            $('.edit-rate-btn').click(function() {
                const userId = $(this).data('userid');
                const currentRate = $(this).data('currentrate');
                const lecturerName = $(this).data('lecturername');

                $('#editUserId').val(userId);
                $('#lecturerName').val(lecturerName);
                $('#newHourlyRate').val(currentRate);

                $('#editRateModal').modal('show');
            });
        });

        function calculateBulkIncrease() {
            const percentage = parseFloat($('#increasePercentage').val());
            if (!percentage || percentage <= 0) {
                alert('Please enter a valid percentage');
                return;
            }

            const currentTotal = @Model.Sum(l => l.HourlyRate);
            const newTotal = currentTotal * (1 + percentage / 100);
            const increaseAmount = newTotal - currentTotal;

            $('#increasePreviewText').html(`
                Current total hourly rate: <strong>R ${currentTotal.toFixed(2)}</strong><br>
                New total hourly rate: <strong>R ${newTotal.toFixed(2)}</strong><br>
                Total increase: <strong class="text-success">R ${increaseAmount.toFixed(2)}</strong>
            `);
            $('#bulkIncreasePreview').show();
        }

        function applyBulkIncrease() {
            const percentage = parseFloat($('#increasePercentage').val());
            if (!percentage || percentage <= 0) {
                alert('Please enter a valid percentage');
                return;
            }

            if (confirm(`Are you sure you want to increase all hourly rates by ${percentage}%?`)) {
                // In a real application, this would call a backend API
                alert('Bulk increase functionality would be implemented here. This would update all lecturer rates in the database.');
                $('#bulkIncreasePreview').hide();
                $('#increasePercentage').val('');
            }
        }

        function exportLecturerData() {
            // Simple CSV export implementation
            const headers = ['Name', 'Email', 'Hourly Rate', 'Phone', 'Status'];
            let csvContent = headers.join(',') + '\n';

            @foreach (var lecturer in Model)
            {
                    <text>
                    csvContent += `"@lecturer.FullName","@lecturer.Email",@lecturer.HourlyRate,"@(lecturer.PhoneNumber ?? "Not set")","Active"\n`;
                    </text>
            }

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'lecturers_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>

    <style>
        .dataTables_wrapper {
            margin-top: 10px;
        }
        .edit-rate-btn {
            margin-right: 5px;
        }
    </style>
}